# 实施计划：OpenClaw 多用户动态连接与持久化 (最终确认版)

根据您的要求，我在执行步骤中增加了关于系统稳定性和文档交付的明确规则。

## 1. 数据库模型更新 (Models)

* **文件**: `app/models/sql_models.py`

* **新增表**: `OpenClawConfig`

  * `id`: 主键 (UUID)

  * `user_id`: 关联用户表 (ForeignKey)

  * `gateway_url`: 网关地址

  * `gateway_token` / `gateway_password`: 鉴权信息

  * `session_key`: 会话 Key

  * `use_ssh`: 是否启用 SSH

  * `ssh_host`, `ssh_port`, `ssh_user`, `ssh_password`: SSH 连接信息

  * `ssh_local_port`: 本地映射端口

## 2. 接口层实现 (Endpoints)

* **文件**: `app/api/endpoints/openclaw.py`

### 2.1 新增接口：POST `/connect`

* **功能**: 建立连接并持久化配置。

* **逻辑**:

  1. 清理旧连接。
  2. 尝试建立 SSH 隧道 (如需) 和 OpenClaw 连接。
  3. **错误处理**:

     * SSH 失败 -> 提示检查 SSH 配置或 AllowTcpForwarding。

     * 连接失败 -> 提示检查 URL 或服务状态。
  4. **成功**: 保存配置到数据库，缓存连接，返回成功。

### 2.2 更新接口：POST `/chat`

* **功能**: 复用连接进行对话。

* **逻辑**: 优先查内存 -> 查库自动重连 -> 失败报错 (提示去设置页配置)。

## 3. 执行步骤 (Execution Steps)

1.  **修改数据模型**: 在 `sql_models.py` 中添加 `OpenClawConfig` 表结构。
2.  **实现业务逻辑**: 修改 `openclaw.py`，实现连接管理、数据库存取和接口逻辑。
3.  **依赖处理**: 确保 `sshtunnel` 和数据库依赖正确集成。
4.  **系统稳定性保障 (关键规则)**: **必须确保 OpenClaw 服务的任何异常（如连接失败、库缺失、运行时错误）都被捕获处理，绝不允许因此导致整个后端服务崩溃或无法启动。**
5.  **交付接口文档 (关键规则)**: **任务完成后，必须输出这两个接口 (`/connect`, `/chat`) 的详细文档，包含：接口地址、请求参数说明、接口作用、成功/失败的响应示例。**

