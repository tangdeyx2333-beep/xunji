## 实施计划：移除强制登录并添加自动用户创建（设置页数据恢复）

### 核心设计思路

**三层用户体系**：

1. **匿名用户**（默认）：自动生成，无密码，使用设备指纹
2. **已命名用户**：用户设置了用户名，但仍无密码
3. **完整用户**：用户设置了用户名和密码（可在设置页恢复数据）

**数据恢复机制**：在设置页面直接添加登录表单，允许用户输入用户名和密码恢复数据，无需跳转到独立登录页。

### 1. 数据库模型调整

**文件**: `xunji-backup/app/models/sql_models.py`

* User 表修改：

  * `hashed_password` 改为可为空（nullable=True）

  * `username` 保持唯一索引，不可为空

  * 添加 `device_id` 字段（String, unique, index）

  * 添加 `is_anonymous` 字段（Boolean, default=True）标记是否为自动创建的匿名用户

### 2. 后端认证逻辑改造

**文件**: `xunji-backup/app/core/security.py`

* 修改 `verify_password` 函数：

  * 如果 `hashed_password` 为 None 或空字符串，直接返回 True（无密码验证）

  * 否则执行正常密码验证

* 修改 `get_password_hash` 函数：

  * 支持密码为 None 或空字符串的情况，返回 None

### 3. 后端认证依赖改造

**文件**: `xunji-backup/app/api/deps.py`

* 修改 `get_current_user` 函数：

  * 从请求头获取 device\_id（优先级高于 Token）

  * 如果有 device\_id：

    * 查询数据库是否存在该 device\_id 的用户

    * 存在则返回用户 + 生成 Token

    * 不存在则创建新用户（匿名用户）

  * 如果有 Token：

    * 解析 Token 获取 user\_id

    * 返回对应用户

  * 如果都没有：

    * 创建新的匿名用户

    * 返回用户 + 生成 Token

### 4. 后端添加用户管理接口

**文件**: `xunji-backup/app/api/endpoints/auth.py`

* 保留原有 `/login` 和 `/register` 接口（用于数据恢复）

* 添加新接口 `POST /api/auth/upgrade-account`：

  * 允许匿名用户设置用户名和密码

  * 验证用户名是否已存在

  * 更新用户信息（username, hashed\_password, is\_anonymous=False）

* 添加新接口 `POST /api/auth/anonymous-login`：

  * 接收 device\_id

  * 返回用户信息和 Token（用于前端初始化）

### 5. 前端：创建设备指纹工具

**文件**: `xunji-frontend/src/utils/deviceFingerprint.js` (新建)

* 生成设备指纹（基于 canvas、userAgent、时区等）

* 提供 getOrCreateDeviceId() 函数

* 将 device\_id 存储在 localStorage（key: `device_id`）

### 6. 前端路由改造

**文件**: `xunji-frontend/src/router/index.js`

* 删除路由守卫（beforeEach）

* 保留 Login 和 Register 路由（用于数据恢复）

* 根路径直接指向 GeminiLayout

* 移除 `requiresAuth` meta 标记

### 7. 前端请求拦截器改造

**文件**: `xunji-frontend/src/utils/request.js`

* 请求拦截器：

  * 从 localStorage 获取 device\_id

  * 无 device\_id 时调用 deviceFingerprint.js 生成

  * 将 device\_id 添加到请求头（`X-Device-ID`）

  * 如果有 Token，也添加到 Authorization 头

* 响应拦截器：

  * 401 错误时不跳转登录页

  * 记录错误日志

### 8. 前端：App.vue 初始化逻辑

**文件**: `xunji-frontend/src/App.vue`

* 在应用启动时：

  * 调用 deviceFingerprint.js 获取 device\_id

  * 调用后端 `/api/auth/anonymous-login` 接口

  * 保存返回的 Token 到 localStorage（`access_token`）

  * 保存用户信息到 localStorage（`user_info`）

  * 保存 device\_id 到 localStorage

### 9. 前端：设置页面添加账号管理

**文件**: `xunji-frontend/src/views/GeminiLayout.vue`

* 在设置面板中添加"账号管理"区域：

  * 显示当前用户状态（匿名/已命名/完整账号）

  * 如果为匿名用户：

    * 显示"设置用户名"输入框

    * 可选的"设置密码"输入框

    * "升级账号"按钮（调用 `/api/auth/upgrade-account`）

  * 如果为已命名用户：

    * 显示"设置密码"输入框

    * "设置密码"按钮

  * **数据恢复区域**：

    * 显示"恢复已有账号"折叠面板

    * 包含用户名和密码输入框

    * "恢复账号"按钮（调用 `/api/auth/login`）

    * 登录成功后：

      * 更新 localStorage 中的 Token

      * 更新 localStorage 中的 device\_id（使用账号关联的 device\_id）

      * 更新当前用户信息

      * 显示成功提示

### 10. 前端：移除原有登录入口

**文件**: `xunji-frontend/src/views/GeminiLayout.vue`

* 移除顶部导航栏的登录/注册按钮

* 移除跳转到登录页面的逻辑

* 所有认证相关操作都在设置页面完成

### 11. Token 永不过期配置

**文件**: `xunji-backup/app/core/security.py`

* 修改 `create_access_token` 函数：

  * 设置过期时间为 10 年（或更长）

  * 确保 Token 中包含 user\_id 和 device\_id

### 12. 安全性考虑

* **设备指纹碰撞**：使用多种浏览器特征生成，碰撞概率极低

* **密码策略**：

  * 匿名用户无密码，无法通过登录恢复（只能通过 device\_id）

  * 设置密码后，必须提供密码才能登录恢复

* **数据迁移**：登录恢复后，自动将当前 device\_id 更新为账号的 device\_id

### 13. 测试验证

* 测试首次访问应用（无 device\_id）- 应创建匿名用户

* 测试刷新页面 - 应使用相同用户

* 测试清除 localStorage 后刷新 - 应创建新匿名用户（数据丢失）

* 测试设置用户名和密码 - 应升级为完整账号

* 测试清除 localStorage 后在设置页恢复账号 - 应恢复数据

* 测试 Token 是否长期有效

### 14. 文档更新

* 更新 DESIGN\_REPORT.md，说明新的认证机制和数据恢复流程

* 更新 TEST\_REPORT.md，添加相关测试用例

* 更新 .env.example，添加相关配置项说明

* 添加用户指南：如何设置账号以保障数据安全

